<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Formula One and Genetic Algorithms | Ben Ewing | Improper Prior</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/">Home</a></li>
      
      <li><a href="/things-i-like/">Links</a></li>
      
      <li><a href="https://github.com/ben-e/">GitHub</a></li>
      
      <li><a href="/index.xml">Subscribe</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Formula One and Genetic Algorithms</span></h1>
<h2 class="author">Ben Ewing</h2>
<h2 class="date">2020/05/20</h2>
</div>

<main>



<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>For all of its flaws, and there are many, I’ve slowly developed an infatuation with <a href="https://en.wikipedia.org/wiki/Formula_One">Formula One</a> over the past year. While the racing and driver narratives are dramatic and entertaining, I think what attracts me most to the sport is the car development.</p>
<p>Each year F1 teams develop and <a href="https://www.youtube.com/watch?v=xG8t1Wc13x8">unveil new cars</a> (warning: loud + flashing lights) adhering to a set of regulations. Throughout the season teams will continue to change their cars, sometimes resulting in <a href="https://www.youtube.com/watch?v=VhPw8gtfgv4">dramatic improvements</a> or <a href="https://en.wikipedia.org/wiki/Haas_VF-19#Developmental_issues">baffling steps backwards</a> in car performance. Initial performance and season long improvements tend to be highly related to team budgets, which vary from an estimated <a href="https://www.racefans.net/2020/01/02/the-cost-of-f1-2019-part-two-what-the-top-teams-spent/">$400 million on the high end</a>, to <a href="https://www.racefans.net/2019/12/27/the-cost-of-f1-2019-team-budgets-analysed-part-one/">$120 million on the low end</a>, though this is not always the case.</p>
<p>Teams work independently to develop their cars, though teams commonly purchase individual parts and engines from each other. Car developmet philosophy can also be very different across times, for example <a href="https://www.youtube.com/watch?v=a__6bJAohhg&amp;t=12s">high and low rake aerodynamics</a>. Often a team will <a href="https://www.youtube.com/watch?v=U_uKHNJLSQs">have a significant development</a> that is copied, or protested, by the other teams. This car development process reminds me strongly of a class of optimization/search algorithms which I am quite fond of: <a href="https://en.wikipedia.org/wiki/Genetic_algorithm">genetic algorithms</a>.</p>
<p>Oh, and for this post I’ll be using entirely base R version 4.0.0 (2020-04-24).</p>
</div>
<div id="a-brief-introduction-to-genetic-algorithms" class="section level2">
<h2>A Brief Introduction to Genetic Algorithms</h2>
<p>Genetic algorithms are a class of search algorithms which aim to find the optimal solution for some objective function with one or many parameters, which need not be known as long as its output can be given, by mimicking biological evolution. In the simplest case the algorithm starts by intializing a population of possible solutions, these can be random or based on some prior knowledge. Then the algorithm proceeds by iteratively evolving the population:</p>
<ol style="list-style-type: decimal">
<li>Score each individual in the population according to the objective function.</li>
<li>Keep the top <span class="math inline">\(m\)</span> scoring individuals; replicate to create a new population.</li>
<li>Add mutation by:
<ul>
<li>Adding random noise to each solution.</li>
<li>Breeding different solutions with each other. For example, forming a new possible solution by taking parameter <span class="math inline">\(a\)</span> from one surviving solution and parameter <span class="math inline">\(b\)</span> from another.</li>
<li><a href="https://en.wikipedia.org/wiki/Crossover_(genetic_algorithm)">There are many well-studied possibilities</a> for otherwise mutating individuals.</li>
</ul></li>
<li>Repeat.</li>
</ol>
<p>While there are many more ways to extend this basic genetic algorithm, I will mention just one other that will be useful later. Rather than running the algorithm with a single</p>
<p>As a simple example, suppose we want to maximize <span class="math inline">\(y = sin(x) + sin(x^2)\)</span> subject to the constraint that <span class="math inline">\(|x| \leq 8\)</span> (ignoring the fact that this is an analytically easy problem). Start by defining the objective function:</p>
<pre class="r"><code># Define the objective function
obj &lt;- function(x) {
  # If outside the bounds then return some very negative number
  ifelse(abs(x) &gt; 8, -9e10, sin(x) + sin(x^2))
}

# Plot the function
x &lt;- seq(-8, 8, 0.01)
plot(x, obj(x), type = &#39;l&#39;)</code></pre>
<p><img src="/post/2020-05-20-formula-1-and-genetic-algorithms_files/figure-html/unnamed-chunk-1-1.png" width="672" /></p>
<p>This function has a few qualities which may make it difficult to optimize. First, while there is only one maxium point, there are a few points which are close. Second, the slopes are quite steep, so taking small steps away from any local maxima may have seemingly bad results, even if that step is actually towards the global maxima.</p>
<p>To proceed with the algorithm create a starting population of potential solutions.</p>
<pre class="r"><code># Create the initial population, uniformly spread across the space
pop_size &lt;- 20
pop &lt;- seq(-8, 8, length.out = pop_size)

# And plot the initial population
plot(x, obj(x), type = &#39;l&#39;)
points(pop, obj(pop), col = &quot;red&quot;)</code></pre>
<p><img src="/post/2020-05-20-formula-1-and-genetic-algorithms_files/figure-html/unnamed-chunk-2-1.png" width="672" /></p>
<p>Now we can enter the main evolutionary loop. Each iteration we keep the five best scoring solutions, and use them to generate a new population.</p>
<pre class="r"><code>generations &lt;- 200

for (i in 0:generations) {
  # Score each member of the population
  scores &lt;- obj(pop)
  
  # Keep the best performing point
  survivors &lt;- order(scores, decreasing = T)[1:5]
  
  # Plot the points every 10th generation
  if (i %% 10 == 0) {
    plot(x, obj(x), type = &#39;l&#39;, main = paste0(&#39;Iteration &#39;, i))
    # Survivors in red, others in blue
    points(pop[-survivors], scores[-survivors], col = &quot;blue&quot;)
    points(pop[survivors], scores[survivors], col = &quot;red&quot;)
  }
  
  
  # Create a new population
  pop &lt;- sample(pop[survivors], size = pop_size, replace = T)
  
  # Mutate by adding some noise, with some probability
  # the probability and amount of mutation control the exploration of the space
  # too high and the algorithm may fail to converge, too low and the space may not
  # be entirely explored
  # Here we might also &quot;breed&quot; multiple solutions if desired
  pop &lt;- pop + runif(pop_size, min = -8, max = 8)*rbinom(pop_size, 1, 0.75)
}</code></pre>
<p><img src="/post/2020-05-20-formula-1-and-genetic-algorithms_files/figure-html/unnamed-chunk-3-.gif" width="672" /></p>
<p>We can see that this works fairly well, but with a bad initialization the algorithm can be stuck at local maxima. The mutation parameters are quite important for exploring the space.</p>
<p>With the stage set, lets go race!</p>
</div>
<div id="simulating-a-formula-one-car-development" class="section level2">
<h2>Simulating a Formula One Car Development</h2>
<p>The extension of the genetic algorithm to F1 is pretty natural. We can treat the performance of the car as the objective function. This function has many parameters, for example the speed of the car depends on many engine tuning parameters, and the cornering ability will depend heavily on the aerodynamic qualities of the car.</p>
<p>Assuming each team can explore a number of different design options, we can treat each team as a separate island of the genetic algorithm. Ocassionally mixing islands allows for teams to copy parameters (see the infamous <a href="https://www.racefans.net/2020/02/28/racing-point-critics-were-naive-about-teams-potential/">‘Tracing Point’</a>).</p>
<p>Team budgets can be interpreted as a limit on the number of designs each team can explore, and the number of iterations of exploration each team gets, such that high budget teams can explore more of the space. Let’s try it.</p>
<p>TODO:
- [ ] Use team colors: <a href="https://www.reddit.com/r/formula1/comments/arxt0r/f1_2019_team_colors_hex_codes/" class="uri">https://www.reddit.com/r/formula1/comments/arxt0r/f1_2019_team_colors_hex_codes/</a>
- [ ] Use actual team budgets: <a href="https://www.racefans.net/2019/12/27/the-cost-of-f1-2019-team-budgets-analysed-part-one/" class="uri">https://www.racefans.net/2019/12/27/the-cost-of-f1-2019-team-budgets-analysed-part-one/</a> and <a href="https://www.racefans.net/2020/01/02/the-cost-of-f1-2019-part-two-what-the-top-teams-spent/" class="uri">https://www.racefans.net/2020/01/02/the-cost-of-f1-2019-part-two-what-the-top-teams-spent/</a></p>
</div>
<div id="adding-noise-driver-quality" class="section level2">
<h2>Adding Noise: Driver Quality</h2>
<p>What if the objective function is noisy? Beyond the car, Formula 1 results also depend on environmental factors (some cars perform well in the heat) and crucially the driver. More experienced drivers are generally able to give better feedback about car performance, and thus better able to help a team develop a car. We can simulate this by adding noise to the objective function, with more experienced drivers providing their teams with less noise.</p>
</div>
<div id="the-effect-of-budget-caps" class="section level2">
<h2>The Effect of Budget Caps</h2>
<p>As we can see in the previous sections, teams with higher budgets are usually able to produce much better cars. This has certainly been the case in Formula One, where the last race won by a team other than Ferrari, Red Bull, and Mercedes was in 2012. To address this issue, F1 has recently imposed a budget cap of $150 million on each team much to the dislike of the bigger teams. This cap does not include certain members of team staff or the drivers. Will this help equalize the teams? We now have the tools to find out!</p>
</div>
<div id="appendix-getting-started-with-formula-one" class="section level2">
<h2>Appendix: Getting Started with Formula One</h2>
<p>Formula One is a pretty intimidating sport to start watching. Coming in as a new watcher it can be hard to tell what’s actually happening in a race or to choose a driver to support. Luckily, Formula One is big enough that there are plenty of resources for the incoming fan:</p>
<ul>
<li><a href="https://www.netflix.com/title/80204890">Formula 1: Drive to Survive</a> - This Netflix show is responsible for introducing me, and many others, to Formula 1 (I blew through the entire first season while recovering from an appedectomy, good times). While it is a good introduction to the sport and most of the drivers (poor Daniil Kvyat), I personally feel that the second season is quite weak, it manufactures non-existent rivalries and ignores <a href="https://www.youtube.com/watch?v=kvTc1z2jWgE">some of the season’s most dramatic moments</a>.</li>
<li><a href="https://www.f1.cool/">Shift+F1</a> - This is probably my favorite F1 podcast. In particular they <a href="https://www.f1.cool/blog/96">produce preseason primers</a> each year to introduce new viewers to the sport and the drivers.</li>
<li><a href="https://www.youtube.com/user/chainbearf1">Chain Bear</a> - Chain Bear produces high quality videos usually picking apart technical aspects of F1.</li>
<li><a href="https://bookshop.org/books/the-mechanic-s-tale/9780752827834">The Mechanic’s Tale by Steve Matchett</a> - This is a great book that really highlights how <em>hard</em> F1.</li>
</ul>
</div>

</main>

  <footer>
  <script src="//yihui.name/js/math-code.js"></script>
<script async src="//mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>

<script async src="//yihui.name/js/center-img.js"></script>

  
  </footer>
  </body>
</html>

